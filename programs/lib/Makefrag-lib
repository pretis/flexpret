# Makefile fragment that specifies adding the required source files to the build
FP_LIB_DIR=$(FLEXPRET_ROOT_DIR)/programs/lib

ifeq ($(MINIMAL_LIBFLEXPRET),true)
LIB_SOURCES += \
	$(FP_LIB_DIR)/flexpret_exceptions.c 
else
LIB_SOURCES += \
	$(FP_LIB_DIR)/syscalls/syscalls.c \
	$(FP_LIB_DIR)/syscalls/printf_putchar.c \
	$(FP_LIB_DIR)/flexpret_thread.c \
	$(FP_LIB_DIR)/flexpret_lock.c \
	$(FP_LIB_DIR)/flexpret_cond.c \
	$(FP_LIB_DIR)/flexpret_exceptions.c \
	$(FP_LIB_DIR)/flexpret_wb.c \
	$(FP_LIB_DIR)/flexpret_uart.c \
	$(FP_LIB_DIR)/flexpret_pbuf.c \
	$(FP_LIB_DIR)/flexpret_io.c \
	$(FP_LIB_DIR)/ctx_switch.S

ifeq ($(PRINTF_ENABLED),true)
LIB_SOURCES += $(FP_LIB_DIR)/printf/src/printf/printf.c
LIB_INCS += 
else
LIB_SOURCES += $(FP_LIB_DIR)/syscalls/printf_stubs.c
endif

endif

# This variable gathers all files generated by make
LIB_AUTOGEN := $(FP_LIB_DIR)/include/flexpret_swconfig.h $(FP_LIB_DIR)/linker/flexpret_swconfig.ld

LIB_INCS += -I$(FP_LIB_DIR)/include -I$(FP_LIB_DIR)/printf/src/

# Default is startup.c, but the application can set this variable to use their own startup file
STARTUP_FILE ?= $(FP_LIB_DIR)/startup.c

# FIXME: This is extremely brittle. start.C HAS TO BE THE FIRST source file passed to gcc in order
#	to have the ResetHandler be linked to 0x00.
STARTUP_SOURCES = $(FP_LIB_DIR)/start.S $(STARTUP_FILE) 

# See https://stackoverflow.com/questions/649246/is-it-possible-to-create-a-multi-line-string-variable-in-a-makefile
define SWCONFIG_HEADER
/**
* This flexpret core config file is auto-generated, and based on the
* configuration used to build the flexpret emulator.
*
* Do not edit.
*
*/
#ifndef FLEXPRET_SWCONFIG_H
#define FLEXPRET_SWCONFIG_H

/* Stack size configuration */
#ifndef STACKSIZE_BITS
#define STACKSIZE_BITS ${STACKSIZE_BITS}
#define STACKSIZE ${STACKSIZE}
#endif

#endif // FLEXPRET_SWCONFIG_H
endef
export SWCONFIG_HEADER

define SWCONFIG_LDSCRIPT
/**
* This flexpret core config file is auto-generated, and based on the
* configuration used to build the flexpret emulator.
*
* Do not edit.
*
*/

STACKSIZE   = ${STACKSIZE} ;
endef
export SWCONFIG_LDSCRIPT

# FORCE is used to ensure target always runs; see 
# https://www.gnu.org/software/make/manual/make.html#Force-Targets (4.7)
FORCE:

$(FP_LIB_DIR)/include/flexpret_swconfig.h: FORCE
	@echo "$$SWCONFIG_HEADER" > $@

$(FP_LIB_DIR)/linker/flexpret_swconfig.ld: FORCE
	@echo "$$SWCONFIG_LDSCRIPT" > $@

autogen: $(LIB_AUTOGEN)